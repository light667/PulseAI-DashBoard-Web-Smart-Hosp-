<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©paration de Compte - PulseAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-tools me-2"></i>R√©paration de Compte</h4>
                    </div>
                    <div class="card-body">
                        <div id="diagnosticSection">
                            <h5>Diagnostic Automatique</h5>
                            <div id="diagnosticResults" class="mt-3"></div>
                            <button id="btnDiagnostic" class="btn btn-primary mt-3">
                                <i class="bi bi-search me-2"></i>Lancer le Diagnostic
                            </button>
                        </div>

                        <div id="repairSection" class="d-none mt-4">
                            <hr>
                            <h5>R√©paration du Compte</h5>
                            <p class="text-muted">Compl√©tez les informations manquantes pour cr√©er votre profil d'h√¥pital</p>
                            
                            <form id="repairForm">
                                <div class="mb-3">
                                    <label class="form-label">Nom de l'√©tablissement *</label>
                                    <input type="text" class="form-control" id="hospitalName" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">T√©l√©phone *</label>
                                    <input type="tel" class="form-control" id="phone" placeholder="+225 XX XX XX XX XX" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Adresse compl√®te *</label>
                                    <textarea class="form-control" id="address" rows="2" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">G√©olocalisation *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="locationStatus" readonly placeholder="Cliquez sur le bouton pour localiser">
                                        <button type="button" class="btn btn-outline-primary" id="btnGetLocation">
                                            <i class="bi bi-geo-alt-fill me-2"></i>D√©tecter ma position
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Services M√©dicaux *</label>
                                    <div id="servicesGrid" class="row g-2"></div>
                                </div>

                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Cr√©er mon Profil Hospitalier
                                </button>
                                <div class="spinner-border spinner-border-sm ms-2 d-none" id="repairSpinner"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <a href="dashboard.html" class="btn btn-link">Retour au Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './src/supabase.js?v=10'
        import { showNotification } from './src/utils/notifications.js?v=10'

        let currentUser = null
        let userLocation = null
        let selectedServices = []
        let allServices = []

        // =======================================================================
        // DIAGNOSTIC
        // =======================================================================
        async function runDiagnostic() {
            const resultsDiv = document.getElementById('diagnosticResults')
            resultsDiv.innerHTML = '<div class="spinner-border text-primary"></div> Diagnostic en cours...'

            const results = []

            try {
                // 1. V√©rifier la session
                const { data: { session } } = await supabase.auth.getSession()
                currentUser = session?.user

                if (!currentUser) {
                    results.push({ icon: 'x-circle', color: 'danger', text: 'Pas de session active - Reconnectez-vous' })
                    resultsDiv.innerHTML = formatResults(results)
                    return
                }

                results.push({ icon: 'check-circle', color: 'success', text: `Session active: ${currentUser.email}` })

                // 2. V√©rifier l'h√¥pital
                const { data: hospital, error: hospitalError } = await supabase
                    .from('hospitals')
                    .select('*')
                    .eq('owner_id', currentUser.id)
                    .maybeSingle()

                if (hospitalError) {
                    results.push({ icon: 'exclamation-triangle', color: 'warning', text: `Erreur DB: ${hospitalError.message}` })
                } else if (!hospital) {
                    results.push({ icon: 'x-circle', color: 'danger', text: 'Aucun h√¥pital associ√© √† ce compte' })
                    document.getElementById('repairSection').classList.remove('d-none')
                    await loadServices()
                } else {
                    results.push({ icon: 'check-circle', color: 'success', text: `H√¥pital trouv√©: ${hospital.name}` })
                    
                    // 3. V√©rifier les services
                    const { data: services } = await supabase
                        .from('hospital_services')
                        .select('*')
                        .eq('hospital_id', hospital.id)

                    results.push({ 
                        icon: 'check-circle', 
                        color: 'success', 
                        text: `${services?.length || 0} service(s) configur√©(s)` 
                    })
                }

            } catch (err) {
                results.push({ icon: 'exclamation-triangle', color: 'danger', text: `Erreur: ${err.message}` })
            }

            resultsDiv.innerHTML = formatResults(results)
        }

        function formatResults(results) {
            return results.map(r => `
                <div class="alert alert-${r.color} d-flex align-items-center mb-2">
                    <i class="bi bi-${r.icon} me-2"></i>
                    ${r.text}
                </div>
            `).join('')
        }

        // =======================================================================
        // CHARGER LES SERVICES
        // =======================================================================
        async function loadServices() {
            const { data, error } = await supabase
                .from('services')
                .select('*')
                .order('category', { ascending: true })
                .order('name', { ascending: true })

            if (error) {
                console.error('Erreur chargement services:', error)
                return
            }

            allServices = data || []
            const grid = document.getElementById('servicesGrid')

            grid.innerHTML = allServices.map(service => `
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${service.id}" id="service${service.id}">
                        <label class="form-check-label" for="service${service.id}">
                            <i class="bi bi-${service.icon} me-1"></i>${service.name}
                        </label>
                    </div>
                </div>
            `).join('')
        }

        // =======================================================================
        // G√âOLOCALISATION
        // =======================================================================
        function handleGeolocation() {
            if (!navigator.geolocation) {
                alert('G√©olocalisation non support√©e')
                return
            }

            const btn = document.getElementById('btnGetLocation')
            const statusInput = document.getElementById('locationStatus')

            btn.disabled = true
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Localisation...'

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    }

                    statusInput.value = `üìç ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`
                    statusInput.classList.add('text-success', 'fw-bold')

                    btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Position enregistr√©e'
                    btn.classList.replace('btn-outline-primary', 'btn-success')
                },
                (error) => {
                    console.error('Erreur g√©olocalisation:', error)
                    alert('Impossible d\'obtenir votre position. Activez la g√©olocalisation.')
                    btn.disabled = false
                    btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i>R√©essayer'
                },
                { enableHighAccuracy: true, timeout: 30000 }
            )
        }

        // =======================================================================
        // R√âPARATION
        // =======================================================================
        async function handleRepair(e) {
            e.preventDefault()

            const name = document.getElementById('hospitalName').value.trim()
            const phone = document.getElementById('phone').value.trim()
            const address = document.getElementById('address').value.trim()

            if (!name || !phone || !address) {
                showNotification('Veuillez remplir tous les champs', 'warning')
                return
            }

            if (!userLocation) {
                showNotification('Veuillez autoriser la g√©olocalisation', 'warning')
                return
            }

            selectedServices = Array.from(document.querySelectorAll('#servicesGrid input:checked'))
                .map(input => parseInt(input.value))

            if (selectedServices.length === 0) {
                showNotification('S√©lectionnez au moins un service', 'warning')
                return
            }

            const spinner = document.getElementById('repairSpinner')
            spinner.classList.remove('d-none')

            try {
                // Cr√©er l'h√¥pital
                const { data: hospital, error: hospitalError } = await supabase
                    .from('hospitals')
                    .insert({
                        owner_id: currentUser.id,
                        name: name,
                        email: currentUser.email,
                        phone: phone,
                        address: address,
                        location: {
                            type: 'Point',
                            coordinates: [userLocation.lng, userLocation.lat]
                        },
                        status: 'pending'
                    })
                    .select()
                    .single()

                if (hospitalError) throw hospitalError

                // Cr√©er les services
                const servicesData = selectedServices.map(serviceId => ({
                    hospital_id: hospital.id,
                    service_id: serviceId
                }))

                const { error: servicesError } = await supabase
                    .from('hospital_services')
                    .insert(servicesData)

                if (servicesError) throw servicesError

                showNotification('Profil cr√©√© avec succ√®s!', 'success')
                setTimeout(() => window.location.href = 'dashboard.html', 2000)

            } catch (err) {
                console.error('Erreur r√©paration:', err)
                showNotification('Erreur: ' + err.message, 'danger')
            } finally {
                spinner.classList.add('d-none')
            }
        }

        // =======================================================================
        // EVENT LISTENERS
        // =======================================================================
        document.getElementById('btnDiagnostic').addEventListener('click', runDiagnostic)
        document.getElementById('btnGetLocation').addEventListener('click', handleGeolocation)
        document.getElementById('repairForm').addEventListener('submit', handleRepair)

        // Lancer diagnostic au chargement
        window.addEventListener('load', runDiagnostic)
    </script>
</body>
</html>
